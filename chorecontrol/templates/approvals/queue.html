{% extends "base.html" %}
{% from "_components/macros.html" import status_badge, btn_primary, empty_state %}

{% block title %}Approval Queue - ChoreControl{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1 class="font-display text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-2">
        Approval Queue
    </h1>
    <p class="text-gray-600 dark:text-gray-400">
        Review and approve pending chores and reward claims
    </p>
</div>

<!-- Pending Chore Instances -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6 mb-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <h2 class="font-display text-2xl font-semibold text-gray-900 dark:text-white">
            Pending Chore Approvals
        </h2>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold bg-gray-500/20 text-gray-700 dark:text-gray-300 border border-gray-500/30 backdrop-blur-sm">
            {{ pending_instances|length if pending_instances else 0 }}
        </span>
    </div>

    <!-- Chore Instances List -->
    {% if pending_instances %}
        <ul class="space-y-4">
            {% for instance in pending_instances %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4 transition-all duration-300 hover:bg-white/15">
                <!-- Instance Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="font-display text-xl font-semibold text-gray-900 dark:text-white">
                        {{ instance.chore.name }}
                    </div>
                    {{ status_badge('claimed') }}
                </div>

                <!-- Instance Details -->
                <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300 mb-4">
                    <div>
                        <strong>{{ instance.claimer.username }}</strong> completed this on
                        {{ instance.claimed_at.strftime('%b %d, %Y at %I:%M %p') }}
                    </div>

                    <div>
                        {% if instance.due_date %}
                            Due date: {{ instance.due_date.strftime('%b %d, %Y') }}
                            {% if instance.claimed_late %}
                                {{ status_badge('pending', 'Claimed Late') }}
                            {% endif %}
                        {% else %}
                            No due date
                        {% endif %}
                    </div>

                    <div>
                        Points to award:
                        <strong>{% if instance.claimed_late and instance.chore.late_points is not none %}{{ instance.chore.late_points }}{% else %}{{ instance.chore.points }}{% endif %}</strong>
                        {% if instance.claimed_late %}
                            {{ status_badge('pending', 'Late') }}
                        {% endif %}
                    </div>

                    {% if instance.chore.description %}
                    <div class="italic">{{ instance.chore.description }}</div>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="flex flex-wrap gap-2 pt-3 border-t border-white/10 dark:border-white/5">
                    <form method="POST"
                          action="{{ url_for('instances.approve_instance', instance_id=instance.id) }}"
                          class="inline-block"
                          data-json-form>
                        <button type="submit"
                                class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                            ‚úì Approve ({% if instance.claimed_late and instance.chore.late_points is not none %}{{ instance.chore.late_points }}{% else %}{{ instance.chore.points }}{% endif %} pts)
                        </button>
                    </form>
                    <button class="inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm"
                            onclick="showRejectModal({{ instance.id }}, '{{ instance.chore.name }}', 'chore')">
                        ‚úó Reject
                    </button>
                    <a href="{{ url_for('ui.chore_detail', id=instance.chore.id) }}"
                       class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                        View Chore
                    </a>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">‚úì</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                All caught up!
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                No pending chore approvals.
            </p>
        </div>
    {% endif %}
</div>

<!-- Pending Reward Claims -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <h2 class="font-display text-2xl font-semibold text-gray-900 dark:text-white">
            Pending Reward Claims
        </h2>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold bg-gray-500/20 text-gray-700 dark:text-gray-300 border border-gray-500/30 backdrop-blur-sm">
            {{ pending_claims|length if pending_claims else 0 }}
        </span>
    </div>

    <!-- Reward Claims List -->
    {% if pending_claims %}
        <ul class="space-y-4">
            {% for claim in pending_claims %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4 transition-all duration-300 hover:bg-white/15">
                <!-- Claim Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="font-display text-xl font-semibold text-gray-900 dark:text-white">
                        {{ claim.reward.name }}
                    </div>
                    {{ status_badge('pending') }}
                </div>

                <!-- Claim Details -->
                <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300 mb-4">
                    <div><strong>{{ claim.user.username }}</strong> claimed this reward</div>
                    <div>Claimed: {{ claim.claimed_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                    <div>
                        Cost: <strong>{{ claim.reward.points_cost }} points</strong>
                        (Current balance: {{ claim.user.points }})
                    </div>

                    {% if claim.reward.description %}
                    <div class="italic">{{ claim.reward.description }}</div>
                    {% endif %}

                    {% if claim.expiration_date %}
                    <div>Expires: {{ claim.expiration_date.strftime('%b %d, %Y') }}</div>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="flex gap-2 pt-3 border-t border-white/10 dark:border-white/5">
                    <form method="POST"
                          action="{{ url_for('rewards.approve_reward_claim', claim_id=claim.id) }}"
                          class="inline-block"
                          data-json-form>
                        <button type="submit"
                                class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                            ‚úì Approve
                        </button>
                    </form>
                    <button class="inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm"
                            onclick="showRejectModal({{ claim.id }}, '{{ claim.reward.name }}', 'reward')">
                        ‚úó Reject & Refund
                    </button>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üéÅ</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                No pending reward claims
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                Reward claims will appear here for approval.
            </p>
        </div>
    {% endif %}
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000] hidden">
    <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <h3 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
            Reject <span id="rejectType"></span>
        </h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            Are you sure you want to reject <strong id="rejectTitle"></strong>?
        </p>
        <form id="rejectForm" method="POST" data-json-form>
            <div id="reasonGroup" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="rejection_reason">
                    Reason (required for chores):
                </label>
                <textarea id="rejection_reason"
                          name="reason"
                          class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-3 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 resize-none"
                          rows="3"
                          placeholder="Please provide a reason for rejection"></textarea>
            </div>
            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-red-500/90 hover:bg-red-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-red-500/20 border border-red-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                    Reject
                </button>
                <button type="button"
                        class="flex-1 bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100"
                        onclick="closeRejectModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showRejectModal(id, title, type) {
    document.getElementById('rejectTitle').textContent = title;
    document.getElementById('rejectType').textContent = type === 'chore' ? 'Chore' : 'Reward Claim';

    if (type === 'chore') {
        document.getElementById('rejectForm').action = "{{ url_for('instances.reject_instance', instance_id=0) }}".replace('/0/', '/' + id + '/');
        document.getElementById('reasonGroup').style.display = 'block';
    } else {
        document.getElementById('rejectForm').action = "{{ url_for('rewards.reject_reward_claim', claim_id=0) }}".replace('/0/', '/' + id + '/');
        document.getElementById('reasonGroup').style.display = 'none';
    }

    document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRejectModal();
    }
});
</script>
{% endblock %}
