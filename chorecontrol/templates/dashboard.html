{% extends "base.html" %}
{% from "_components/macros.html" import glass_card, status_badge, btn_primary, btn_secondary, btn_sm, btn_danger, empty_state, points_badge, modal %}

{% block title %}Dashboard - ChoreControl{% endblock %}

{% block content %}
<!-- Page Header - Compact -->
<div class="mb-4">
    <h1 class="font-display text-3xl font-bold text-gray-900 dark:text-white mb-1">
      Dashboard
    </h1>
    <p class="text-base text-gray-600 dark:text-gray-400">
      Welcome back, <span class="font-semibold text-green-600 dark:text-green-400">{{ current_user.username }}</span>!
    </p>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <!-- Stat Card 1: Pending Approvals -->
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl p-4 text-center transition-all duration-300 hover:bg-white/15 cursor-pointer" onclick="window.location.href='{{ url_for('ui.approval_queue') }}'">
      <div class="text-3xl md:text-4xl font-display font-bold text-green-600 dark:text-green-400 mb-1">
        {{ stats.pending_approvals }}
      </div>
      <div class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">
        Pending Approvals
      </div>
    </div>

    <!-- Stat Card 2: Reward Claims -->
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl p-4 text-center transition-all duration-300 hover:bg-white/15">
      <div class="text-3xl md:text-4xl font-display font-bold text-purple-600 dark:text-purple-400 mb-1">
        {{ stats.pending_rewards }}
      </div>
      <div class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">
        Reward Claims
      </div>
    </div>

    <!-- Stat Card 3: Completed Today -->
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl p-4 text-center transition-all duration-300 hover:bg-white/15">
      <div class="text-3xl md:text-4xl font-display font-bold text-blue-600 dark:text-blue-400 mb-1">
        {{ stats.today_completed }}
      </div>
      <div class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">
        Completed Today
      </div>
    </div>

    <!-- Stat Card 4: Active Chores -->
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl p-4 text-center transition-all duration-300 hover:bg-white/15">
      <div class="text-3xl md:text-4xl font-display font-bold text-gray-900 dark:text-white mb-1">
        {{ stats.active_chores }}
      </div>
      <div class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">
        Active Chores
      </div>
    </div>
</div>

<!-- Pending Approvals Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mb-6">
    <!-- Card Header -->
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-300/20 dark:border-gray-600/20">
      <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
        Pending Approvals
      </h2>
      {{ btn_sm('View All', href=url_for('ui.approval_queue'), variant='primary') }}
    </div>

    {% if pending_instances %}
        <div class="space-y-3">
            {% for instance in pending_instances %}
            <div class="bg-white/30 dark:bg-white/5 backdrop-blur-sm border border-gray-200/50 dark:border-gray-700/50 rounded-xl p-4 transition-all duration-200 hover:bg-white/40 hover:shadow-md">
                <!-- Item Header -->
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-semibold text-lg text-gray-900 dark:text-white">
                    {{ instance.chore.name }}
                  </h3>
                  {{ status_badge('claimed', 'Claimed') }}
                </div>

                <!-- Metadata -->
                <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400 mb-4">
                  <p>
                    <span class="font-semibold text-gray-900 dark:text-white">{{ instance.claimer.username }}</span>
                    completed this on {{ instance.claimed_at.strftime('%b %d, %Y at %I:%M %p') }}
                  </p>
                  <p>
                    {% if instance.due_date %}
                      Due: {{ instance.due_date.strftime('%b %d, %Y') }}
                    {% else %}
                      Due: Anytime
                    {% endif %}
                    {% if instance.claimed_late %}
                      {{ status_badge('warning', 'Claimed Late') }}
                    {% endif %}
                  </p>
                  <p>
                    Points: <span class="font-semibold text-green-600 dark:text-green-400">{{ instance.points_value }}</span>
                    {% if instance.claimed_late and instance.chore.late_points %}
                        (Late: {{ instance.chore.late_points }})
                    {% endif %}
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex flex-wrap gap-2">
                  <form method="POST" action="{{ url_for('instances.approve_instance', instance_id=instance.id) }}" data-json-form class="inline">
                    {{ btn_sm('âœ“ Approve', type='submit', variant='primary') }}
                  </form>

                  {{ btn_sm('âœ— Reject', onclick="showRejectModal(" ~ instance.id ~ ", '" ~ instance.chore.name ~ "')", variant='danger') }}

                  {{ btn_sm('View Chore', href=url_for('ui.chore_detail', id=instance.chore.id)) }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        {{ empty_state('âœ“', 'All caught up!', 'No pending chore approvals at the moment.') }}
    {% endif %}
</div>

<!-- Kids' Points Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mb-6">
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-300/20 dark:border-gray-600/20">
      <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
        Kids' Points
      </h2>
      {{ btn_sm('Manage', href=url_for('ui.users_list')) }}
    </div>

    {% if kids %}
        <div class="space-y-3">
            {% for kid in kids %}
            <div class="bg-white/30 dark:bg-white/5 backdrop-blur-sm border border-gray-200/50 dark:border-gray-700/50 rounded-xl p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                <h3 class="font-semibold text-lg text-gray-900 dark:text-white">
                  {{ kid.username }}
                </h3>

                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                  <!-- Points Badge -->
                  {{ points_badge(kid.points) }}

                  <!-- Action Buttons -->
                  <div class="flex gap-2 flex-wrap">
                    {{ btn_sm('View History', href=url_for('ui.user_detail', id=kid.id), variant='primary', extra_classes='text-xs') }}
                    {{ btn_sm('Adjust Points', onclick="showPointsAdjustModal(" ~ kid.id ~ ", '" ~ kid.username ~ "', " ~ kid.points ~ ")", extra_classes='text-xs') }}
                  </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        {{ empty_state('ðŸ‘¥', 'No kids yet', 'Add kids to start tracking chores and points.', 'Add User', url_for('ui.users_list')) }}
    {% endif %}
</div>

<!-- Recent Activity Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4">
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-300/20 dark:border-gray-600/20">
      <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
        Recent Activity
      </h2>
    </div>

    {% if recent_activity %}
        <div class="space-y-3">
            {% for activity in recent_activity %}
            <div class="bg-white/30 dark:bg-white/5 backdrop-blur-sm border border-gray-200/50 dark:border-gray-700/50 rounded-xl p-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="font-semibold text-gray-900 dark:text-white">{{ activity.chore.title }}</div>
                  {{ status_badge(activity.status, activity.status|title) }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    {% if activity.status == 'approved' %}
                        <p><strong class="text-gray-900 dark:text-white">{{ activity.claimer.username }}</strong> completed and earned <strong class="text-green-600 dark:text-green-400">{{ activity.points_awarded }} points</strong></p>
                        <p class="text-xs">Approved {{ activity.approved_at.strftime('%b %d at %I:%M %p') }}</p>
                    {% elif activity.status == 'rejected' %}
                        <p><strong class="text-gray-900 dark:text-white">{{ activity.claimer.username }}</strong>'s completion was rejected</p>
                        {% if activity.rejection_reason %}
                        <p class="text-xs italic">Reason: {{ activity.rejection_reason }}</p>
                        {% endif %}
                    {% elif activity.status == 'missed' %}
                        <p>Missed by <strong class="text-gray-900 dark:text-white">{{ activity.assigned_user.username if activity.assigned_user else 'Unassigned' }}</strong></p>
                    {% endif %}
                    <p class="text-xs">
                      Due date:
                      {% if activity.due_date %}
                        {{ activity.due_date.strftime('%b %d, %Y') }}
                      {% else %}
                        Anytime
                      {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        {{ empty_state('ðŸ“‹', 'No recent activity', '') }}
    {% endif %}
</div>

<!-- Reject Modal -->
{% call modal('rejectModal', 'Reject Chore Completion') %}
    <p class="text-gray-600 dark:text-gray-400 mb-6">
      Are you sure you want to reject <strong id="rejectChoreTitle" class="text-gray-900 dark:text-white"></strong>?
    </p>

    <form id="rejectForm" method="POST" data-json-form class="space-y-4">
        <div>
            <label for="rejection_reason" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
              Reason <span class="text-red-500">*</span>
            </label>
            <textarea
              id="rejection_reason"
              name="reason"
              rows="3"
              required
              placeholder="Please provide a reason for rejection"
              class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500/50 focus:border-red-500/50"
            ></textarea>
        </div>

        <div class="flex gap-3">
            {{ btn_danger('Reject', type='submit', extra_classes='flex-1') }}
            {{ btn_secondary('Cancel', onclick='closeRejectModal()', extra_classes='flex-1') }}
        </div>
    </form>
{% endcall %}

<!-- Points Adjustment Modal -->
{% call modal('pointsModal', 'Adjust Points') %}
    <p class="text-gray-600 dark:text-gray-400 mb-6">
      Adjust points for <strong id="pointsUsername" class="text-gray-900 dark:text-white"></strong> (Current: <span id="pointsCurrent" class="text-green-600 dark:text-green-400 font-bold"></span>)
    </p>

    <form id="pointsForm" method="POST" action="{{ url_for('points.adjust_points') }}" data-json-form class="space-y-4">
        <input type="hidden" id="pointsUserId" name="user_id">

        <div>
            <label for="points_delta" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
              Points Change <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="points_delta"
              name="points_delta"
              required
              placeholder="e.g., 10 or -5"
              class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50"
            />
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Use positive numbers to add points, negative to subtract</p>
        </div>

        <div>
            <label for="points_reason" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
              Reason <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="points_reason"
              name="reason"
              required
              placeholder="e.g., Bonus for helping out"
              class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50"
            />
        </div>

        <div class="flex gap-3">
            {{ btn_primary('Adjust Points', type='submit', extra_classes='flex-1') }}
            {{ btn_secondary('Cancel', onclick='closePointsModal()', extra_classes='flex-1') }}
        </div>
    </form>
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
function showRejectModal(instanceId, choreTitle) {
    document.getElementById('rejectChoreTitle').textContent = choreTitle;
    document.getElementById('rejectForm').action = "{{ url_for('instances.reject_instance', instance_id=0) }}".replace('/0/', '/' + instanceId + '/');
    const modal = document.getElementById('rejectModal');
    modal.style.display = 'flex';
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
}

function showPointsAdjustModal(userId, username, currentPoints) {
    document.getElementById('pointsUsername').textContent = username;
    document.getElementById('pointsCurrent').textContent = currentPoints;
    document.getElementById('pointsUserId').value = userId;
    document.getElementById('pointsModal').style.display = 'flex';
}

function closePointsModal() {
    document.getElementById('pointsModal').style.display = 'none';
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRejectModal();
        closePointsModal();
    }
});
</script>
{% endblock %}
