{% extends "base.html" %}
{% from "_components/macros.html" import status_badge %}

{% block title %}User Mapping - ChoreControl{% endblock %}

{% block content %}
<!-- Page Header - Compact -->
<div class="mb-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <h1 class="font-display text-3xl font-bold text-gray-900 dark:text-white">
            User Mapping
        </h1>
        <form method="POST" action="{{ url_for('user_mapping.refresh_user_cache') }}" class="inline">
            <button type="submit"
                    class="touch-btn inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-semibold px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 text-base">
                üîÑ Refresh Cache
            </button>
        </form>
    </div>
    <p class="text-base text-gray-600 dark:text-gray-400 mt-2">
        Assign roles to Home Assistant users. You can proactively assign roles to any HA user, even before they access the addon.
    </p>
</div>

<!-- HA API Warning -->
{% if not ha_api_available %}
<div class="bg-yellow-500/10 dark:bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-6">
    <div class="flex items-start gap-3">
        <div class="text-2xl">‚ö†Ô∏è</div>
        <div class="flex-1">
            <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                Home Assistant API Unavailable
            </h3>
            <p class="text-sm text-gray-700 dark:text-gray-300">
                Cannot fetch HA users directly. Users will be auto-created when they first access the addon.
            </p>
        </div>
    </div>
</div>
{% endif %}

<form method="POST" action="{{ url_for('user_mapping.update_mappings') }}">
    <!-- Home Assistant Users Section -->
    {% if ha_api_available and ha_users %}
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mb-6">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-white/10 dark:border-white/5">
            <div>
                <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
                    üè† Home Assistant Users
                </h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ ha_users|length }} users from Home Assistant</p>
            </div>
        </div>

        <ul class="space-y-4">
            {% for ha_user in ha_users %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4
                       {% if not ha_user.cc_user %}border-l-4 border-l-gray-500/50{% elif ha_user.cc_role == 'unmapped' %}border-l-4 border-l-yellow-500/50{% endif %}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                            {{ ha_user.ha_name }}
                            {% if ha_user.is_owner %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-yellow-400/20 text-yellow-700 dark:text-yellow-300 border border-yellow-500/30">
                                üëë Owner
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if ha_user.cc_user %}
                        {% if ha_user.cc_role == 'parent' %}
                            {{ status_badge('active', 'parent') }}
                        {% elif ha_user.cc_role == 'kid' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-purple-500/20 text-purple-700 dark:text-purple-300 border border-purple-500/30 backdrop-blur-sm">kid</span>
                        {% else %}
                            {{ status_badge('pending', ha_user.cc_role) }}
                        {% endif %}
                    {% else %}
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold bg-gray-500/20 text-gray-700 dark:text-gray-300 border border-gray-500/30 backdrop-blur-sm">
                            Not synced
                        </span>
                    {% endif %}
                </div>

                <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-3">
                    <div><strong>HA User ID:</strong> {{ ha_user.ha_user_id }}</div>
                    <div><strong>Username:</strong> {{ ha_user.ha_username }}</div>
                    {% if not ha_user.is_active %}
                    <div class="text-red-600 dark:text-red-400">‚ö†Ô∏è Inactive in Home Assistant</div>
                    {% endif %}
                </div>

                <div>
                    {% if ha_user.cc_user %}
                        <div class="text-green-600 dark:text-green-400 font-medium text-sm">
                            ‚úì Synced to ChoreControl
                        </div>
                    {% else %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Assign Role:
                            </label>
                            <select name="ha_role_{{ ha_user.ha_user_id }}"
                                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 role-select">
                                <option value="" selected>-- Not synced --</option>
                                <option value="parent">Parent</option>
                                <option value="kid">Kid</option>
                                <option value="claim_only">Claim Only</option>
                                <option value="unmapped">Unmapped</option>
                            </select>
                        </div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Unmapped Users Section -->
    {% if unmapped_users %}
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-yellow-500/30 border-l-4 rounded-xl shadow-lg shadow-black/5 p-4 mb-6">
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10 dark:border-white/5">
            <div class="text-2xl">‚ö†Ô∏è</div>
            <div>
                <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
                    Unmapped Users
                </h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ unmapped_users|length }} users need role assignment</p>
            </div>
        </div>

        <ul class="space-y-4">
            {% for user in unmapped_users %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                <div class="flex items-start justify-between mb-3">
                    <div class="font-semibold text-gray-900 dark:text-white">
                        {{ user.username }}
                    </div>
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-yellow-500/20 text-yellow-700 dark:text-yellow-300 border border-yellow-500/30 backdrop-blur-sm">
                        unmapped
                    </span>
                </div>

                <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-3">
                    <div><strong>HA User ID:</strong> {{ user.ha_user_id }}</div>
                    <div><strong>Created:</strong> {{ user.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Assign Role:
                    </label>
                    <select name="role_{{ user.id }}"
                            class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 role-select">
                        <option value="unmapped" selected>Unmapped</option>
                        <option value="parent">Parent</option>
                        <option value="kid">Kid</option>
                        <option value="claim_only">Claim Only</option>
                    </select>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- All Users Section -->
    <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mb-6">
        <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white mb-4 pb-3 border-b border-white/10 dark:border-white/5">
            All Users
        </h2>

        <!-- Parents -->
        {% if parents %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                Parents ({{ parents|length }})
            </h3>
            <ul class="space-y-4">
                {% for user in parents %}
                <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <a href="{{ url_for('ui.user_detail', id=user.id) }}"
                               class="font-semibold text-gray-900 dark:text-white hover:text-green-500 dark:hover:text-green-400 transition-colors duration-200">
                                {{ user.username }}
                            </a>
                        </div>
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-blue-500/20 text-blue-700 dark:text-blue-300 border border-blue-500/30 backdrop-blur-sm">
                            parent
                        </span>
                    </div>

                    <div class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                        <strong>HA User ID:</strong> {{ user.ha_user_id }}
                    </div>

                    <div>
                        {% if user.ha_user_id.startswith('local-') %}
                            <span class="text-sm text-gray-600 dark:text-gray-400 italic">
                                Local account (role locked)
                            </span>
                        {% else %}
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Change Role:
                            </label>
                            <select name="role_{{ user.id }}"
                                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 role-select">
                                <option value="parent" selected>Parent</option>
                                <option value="kid">Kid</option>
                                <option value="claim_only">Claim Only</option>
                                <option value="unmapped">Unmapped</option>
                            </select>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Kids -->
        {% if kids %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                Kids ({{ kids|length }})
            </h3>
            <ul class="space-y-4">
                {% for user in kids %}
                <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <a href="{{ url_for('ui.user_detail', id=user.id) }}"
                               class="font-semibold text-gray-900 dark:text-white hover:text-green-500 dark:hover:text-green-400 transition-colors duration-200">
                                {{ user.username }}
                            </a>
                        </div>
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-purple-500/20 text-purple-700 dark:text-purple-300 border border-purple-500/30 backdrop-blur-sm">
                            kid
                        </span>
                    </div>

                    <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-3">
                        <div><strong>HA User ID:</strong> {{ user.ha_user_id }}</div>
                        <div class="flex items-center gap-2">
                            <strong>Points:</strong>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-500/20 text-green-700 dark:text-green-300 border border-green-500/30">
                                {{ user.points }}
                            </span>
                        </div>
                    </div>

                    <div>
                        {% if user.ha_user_id.startswith('local-') %}
                            <span class="text-sm text-gray-600 dark:text-gray-400 italic">
                                Local account (role locked)
                            </span>
                        {% else %}
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Change Role:
                            </label>
                            <select name="role_{{ user.id }}"
                                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 role-select">
                                <option value="kid" selected>Kid</option>
                                <option value="parent">Parent</option>
                                <option value="claim_only">Claim Only</option>
                                <option value="unmapped">Unmapped</option>
                            </select>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Claim Only Users -->
        {% if claim_only_users %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                Claim Only ({{ claim_only_users|length }})
            </h3>
            <ul class="space-y-4">
                {% for user in claim_only_users %}
                <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="font-semibold text-gray-900 dark:text-white">
                            {{ user.username }}
                        </div>
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-orange-500/20 text-orange-700 dark:text-orange-300 border border-orange-500/30 backdrop-blur-sm">
                            claim only
                        </span>
                    </div>

                    <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-3">
                        <div><strong>HA User ID:</strong> {{ user.ha_user_id }}</div>
                    </div>

                    <div>
                        {% if not user.ha_user_id.startswith('local-') %}
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Change Role:
                            </label>
                            <select name="role_{{ user.id }}"
                                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 role-select">
                                <option value="claim_only" selected>Claim Only</option>
                                <option value="parent">Parent</option>
                                <option value="kid">Kid</option>
                                <option value="unmapped">Unmapped</option>
                            </select>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- System Users -->
        {% if system_users %}
        <div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                System ({{ system_users|length }})
            </h3>
            <ul class="space-y-4">
                {% for user in system_users %}
                <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="font-semibold text-gray-900 dark:text-white">
                            {{ user.username }}
                        </div>
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase bg-gray-500/20 text-gray-700 dark:text-gray-300 border border-gray-500/30 backdrop-blur-sm">
                            system
                        </span>
                    </div>

                    <div class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                        <strong>HA User ID:</strong> {{ user.ha_user_id }}
                    </div>

                    <div>
                        <span class="text-sm text-gray-600 dark:text-gray-400 italic">
                            System account (role locked)
                        </span>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if not parents and not kids and not claim_only_users and not system_users %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üë•</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                No mapped users
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                When Home Assistant users access the addon, they'll appear here.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Save Button -->
    <div class="flex gap-3">
        <button type="submit"
                class="touch-btn inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-semibold px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 text-base">
            üíæ Save Changes
        </button>
        <a href="{{ url_for('ui.users_list') }}"
           class="touch-btn inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-semibold px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 text-base">
            Cancel
        </a>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
// Highlight changed dropdowns
document.querySelectorAll('.role-select').forEach(select => {
    const originalValue = select.value;
    select.addEventListener('change', function() {
        if (this.value !== originalValue) {
            this.style.backgroundColor = 'rgba(250, 204, 21, 0.1)';
            this.style.borderColor = 'rgba(250, 204, 21, 0.5)';
        } else {
            this.style.backgroundColor = '';
            this.style.borderColor = '';
        }
    });
});

// Confirm before saving if no changes made
document.querySelector('form').addEventListener('submit', function(e) {
    const changedSelects = Array.from(document.querySelectorAll('.role-select')).filter(select => {
        return select.value !== select.querySelector('option[selected]')?.value;
    });

    if (changedSelects.length === 0) {
        const proceed = confirm('No changes detected. Save anyway?');
        if (!proceed) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}
