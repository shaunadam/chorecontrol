{% extends "base.html" %}
{% from "_components/macros.html" import status_badge, empty_state %}

{% block title %}{{ user.username }} - ChoreControl{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-6">
    <a href="{{ url_for('ui.users_list') }}"
       class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
        ‚Üê Back to Users
    </a>
</div>

<!-- User Profile Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6 mb-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <div>
            <h1 class="font-display text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-3">
                {{ user.username }}
            </h1>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold uppercase
                         {% if user.role == 'parent' %}bg-blue-500/20 text-blue-700 dark:text-blue-300 border border-blue-500/30{% elif user.role == 'kid' %}bg-purple-500/20 text-purple-700 dark:text-purple-300 border border-purple-500/30{% else %}bg-gray-500/20 text-gray-700 dark:text-gray-300 border border-gray-500/30{% endif %}
                         backdrop-blur-sm">
                {{ user.role }}
            </span>
        </div>
        <div class="flex gap-2">
            <button onclick="showEditUserModal()"
                    class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                Edit
            </button>
            <button onclick="showDeleteUserModal()"
                    class="inline-flex items-center bg-red-500/90 hover:bg-red-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-lg shadow-red-500/20 border border-red-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                Delete
            </button>
        </div>
    </div>

    <!-- User Info -->
    <div class="mb-6">
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Home Assistant ID
        </h3>
        <p class="text-gray-900 dark:text-white font-mono">{{ user.ha_user_id }}</p>
    </div>

    <!-- Stats Grid (for kids only) -->
    {% if user.role == 'kid' %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-green-500 dark:text-green-400 mb-1">
                {{ user.points }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Current Points</div>
        </div>

        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-1">
                {{ stats.total_completed }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Chores Completed</div>
        </div>

        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-1">
                {{ stats.total_points_earned }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Points Earned</div>
        </div>

        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-1">
                {{ stats.total_rewards_claimed }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Rewards Claimed</div>
        </div>
    </div>

    <div class="mb-6">
        <button onclick="showPointsAdjustModal()"
                class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
            Adjust Points
        </button>
    </div>
    {% endif %}

    <!-- Account Details -->
    <div>
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Account Details
        </h3>
        <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
            <div><strong>Member since:</strong> {{ user.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
            <div><strong>Last updated:</strong> {{ user.updated_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
        </div>
    </div>
</div>

{% if user.role == 'kid' %}
<!-- Points History -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6 mb-8">
    <h2 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        Points History
    </h2>

    {% if points_history %}
        <ul class="space-y-4">
            {% for entry in points_history %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                <div class="flex items-start justify-between mb-3">
                    <div class="font-semibold text-gray-900 dark:text-white">{{ entry.reason }}</div>
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold
                                 {% if entry.points_delta > 0 %}bg-green-500/20 text-green-700 dark:text-green-300 border border-green-500/30{% else %}bg-red-500/20 text-red-700 dark:text-red-300 border border-red-500/30{% endif %}
                                 backdrop-blur-sm">
                        {% if entry.points_delta > 0 %}+{% endif %}{{ entry.points_delta }}
                    </span>
                </div>

                <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                    <div>{{ entry.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                    <div><strong>Balance after:</strong> {{ entry.balance_after }}</div>

                    {% if entry.chore_instance %}
                    <div>
                        Related to: <a href="{{ url_for('ui.chore_detail', id=entry.chore_instance.chore_id) }}"
                                       class="text-green-500 hover:text-green-400 underline">
                            {{ entry.chore_instance.chore.name }}
                        </a>
                    </div>
                    {% endif %}

                    {% if entry.reward_claim %}
                    <div>Related to: Reward claim - {{ entry.reward_claim.reward.name }}</div>
                    {% endif %}

                    {% if entry.created_by %}
                    <div>Created by: {{ entry.created_by.username }}</div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>

        <!-- Pagination -->
        {% if pagination %}
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 pt-6 border-t border-white/10 dark:border-white/5">
            <div class="text-sm text-gray-600 dark:text-gray-400">
                Showing {{ pagination.start }} - {{ pagination.end }} of {{ pagination.total }}
            </div>
            <div class="flex gap-2">
                {% if pagination.has_prev %}
                <a href="?page={{ pagination.prev_page }}"
                   class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                    Previous
                </a>
                {% endif %}
                <span class="inline-flex items-center bg-green-500/20 text-green-700 dark:text-green-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-green-500/30 text-sm">
                    Page {{ pagination.page }}
                </span>
                {% if pagination.has_next %}
                <a href="?page={{ pagination.next_page }}"
                   class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">‚≠ê</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                No points history yet
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                Points transactions will appear here.
            </p>
        </div>
    {% endif %}
</div>

<!-- Assigned Chores -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6">
    <h2 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        Assigned Chores
    </h2>

    {% if assigned_chores %}
        <ul class="space-y-4">
            {% for chore in assigned_chores %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
                <div class="flex items-start justify-between mb-3">
                    <div class="font-display text-xl font-semibold text-gray-900 dark:text-white">
                        <a href="{{ url_for('ui.chore_detail', id=chore.id) }}"
                           class="hover:text-green-500 dark:hover:text-green-400 transition-colors duration-200">
                            {{ chore.name }}
                        </a>
                    </div>
                    {{ status_badge('active' if chore.is_active else 'inactive') }}
                </div>

                <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                    <div>
                        <strong>Points:</strong> {{ chore.points }}
                        {% if chore.late_points %} | <strong>Late:</strong> {{ chore.late_points }}{% endif %}
                    </div>
                    <div>
                        <strong>Recurrence:</strong>
                        {% if chore.recurrence_pattern %}
                            {{ chore.recurrence_pattern }}
                        {% else %}
                            One-time
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üìã</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                No assigned chores
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                Assign chores from the <a href="{{ url_for('ui.chores_list') }}" class="text-green-500 hover:text-green-400 underline">Chores page</a>.
            </p>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000] hidden">
    <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <h3 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-6">Edit User</h3>
        <form method="POST" action="{{ url_for('users.update_user', user_id=user.id) }}" data-json-form>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="username">
                    Username *
                </label>
                <input type="text"
                       id="username"
                       name="username"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       value="{{ user.username }}"
                       required>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="ha_user_id">
                    Home Assistant User ID *
                </label>
                <input type="text"
                       id="ha_user_id"
                       name="ha_user_id"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       value="{{ user.ha_user_id }}"
                       required>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="role">
                    Role *
                </label>
                <select id="role"
                        name="role"
                        class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                        required>
                    <option value="kid" {% if user.role == 'kid' %}selected{% endif %}>Kid</option>
                    <option value="parent" {% if user.role == 'parent' %}selected{% endif %}>Parent</option>
                </select>
            </div>

            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-green-500/90 hover:bg-green-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                    Update User
                </button>
                <button type="button"
                        class="flex-1 bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100"
                        onclick="closeEditUserModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Points Adjustment Modal -->
<div id="pointsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000] hidden">
    <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <h3 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">Adjust Points</h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            Current balance: <strong class="text-green-500 dark:text-green-400 text-xl">{{ user.points }}</strong>
        </p>
        <form method="POST" action="{{ url_for('points.adjust_points') }}" data-json-form>
            <input type="hidden" name="user_id" value="{{ user.id }}">

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="points_delta">
                    Points Change:
                </label>
                <input type="number"
                       id="points_delta"
                       name="points_delta"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       required>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    Use positive numbers to add points, negative to subtract
                </p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="points_reason">
                    Reason:
                </label>
                <input type="text"
                       id="points_reason"
                       name="reason"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       required>
            </div>

            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-green-500/90 hover:bg-green-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                    Adjust Points
                </button>
                <button type="button"
                        class="flex-1 bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100"
                        onclick="closePointsModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div id="deleteUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000] hidden">
    <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <h3 class="font-display text-2xl font-semibold text-red-600 dark:text-red-400 mb-2">Delete User</h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            Are you sure you want to delete <strong>{{ user.username }}</strong>? This action cannot be undone and will permanently delete:
        </p>
        <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 mb-6 space-y-1">
            <li>User account</li>
            <li>All chore assignments</li>
            <li>Points history</li>
            <li>Reward claims</li>
        </ul>
        <form id="deleteUserForm" method="DELETE" action="{{ url_for('users.delete_user', user_id=user.id) }}" data-json-form data-redirect="{{ url_for('ui.users_list') }}">
            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-red-500/90 hover:bg-red-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-red-500/20 border border-red-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                    Delete Permanently
                </button>
                <button type="button"
                        class="flex-1 bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100"
                        onclick="closeDeleteUserModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showEditUserModal() {
    document.getElementById('editUserModal').classList.remove('hidden');
}

function closeEditUserModal() {
    document.getElementById('editUserModal').classList.add('hidden');
}

function showPointsAdjustModal() {
    document.getElementById('pointsModal').classList.remove('hidden');
}

function closePointsModal() {
    document.getElementById('pointsModal').classList.add('hidden');
}

function showDeleteUserModal() {
    document.getElementById('deleteUserModal').classList.remove('hidden');
}

function closeDeleteUserModal() {
    document.getElementById('deleteUserModal').classList.add('hidden');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditUserModal();
        closePointsModal();
        closeDeleteUserModal();
    }
});
</script>
{% endblock %}
