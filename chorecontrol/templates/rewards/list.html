{% extends "base.html" %}
{% from "_components/macros.html" import glass_card, status_badge, btn_primary, btn_secondary, btn_danger, btn_sm, empty_state, points_badge %}

{% block title %}Rewards - ChoreControl{% endblock %}

{% block content %}
<!-- Page Header - Compact -->
<div class="mb-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <h1 class="font-display text-3xl font-bold text-gray-900 dark:text-white">
            Rewards
        </h1>
        <a href="{{ url_for('ui.reward_form') }}"
           class="touch-btn inline-flex items-center justify-center bg-green-500/90 hover:bg-green-500 text-white font-semibold px-5 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 text-base">
            <span class="text-xl mr-2">+</span> Add Reward
        </a>
    </div>
</div>

<!-- Filters Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mb-4">
    <form method="GET">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Filter by Status
        </label>
        <select name="active"
                class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                onchange="this.form.submit()">
            <option value="">All Rewards</option>
            <option value="true" {% if request.args.get('active') == 'true' %}selected{% endif %}>Active Only</option>
            <option value="false" {% if request.args.get('active') == 'false' %}selected{% endif %}>Inactive Only</option>
        </select>
    </form>
</div>

<!-- Rewards List -->
{% if rewards %}
    <div class="space-y-3 mb-4">
        {% for reward in rewards %}
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 transition-all duration-300 hover:bg-white/15">
            <!-- Reward Header -->
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h3 class="font-display text-xl font-semibold text-gray-900 dark:text-white mb-1">
                        {{ reward.name }}
                    </h3>
                </div>
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-br from-red-500/30 to-orange-500/30 text-red-700 dark:text-red-300 border border-red-500/40 backdrop-blur-sm">
                        {{ reward.points_cost }} pts
                    </span>
                    {{ status_badge('active' if reward.is_active else 'inactive') }}
                </div>
            </div>

            <!-- Description -->
            {% if reward.description %}
            <p class="text-gray-700 dark:text-gray-300 mb-3 text-base">
                {{ reward.description }}
            </p>
            {% endif %}

            <!-- Reward Details -->
            <div class="space-y-2 text-sm mb-3">
                {% if reward.cooldown_days or reward.limit_per_kid or reward.expiration_days %}
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-gray-700 dark:text-gray-300">
                    {% if reward.cooldown_days %}
                    <span><strong>Cooldown:</strong> {{ reward.cooldown_days }} day(s)</span>
                    {% endif %}
                    {% if reward.limit_per_kid %}
                    <span><strong>Limit:</strong> {{ reward.limit_per_kid }} per kid</span>
                    {% endif %}
                    {% if reward.expiration_days %}
                    <span><strong>Expires in:</strong> {{ reward.expiration_days }} day(s)</span>
                    {% endif %}
                </div>
                {% endif %}

                <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                    <strong>Claims:</strong> {{ reward.total_claims or 0 }} total
                    {% if reward.pending_claims > 0 %}
                        <span class="ml-2">|</span>
                        {{ status_badge('pending', reward.pending_claims ~ ' pending') }}
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-2 pt-3 border-t border-white/10 dark:border-white/5">
                <a href="{{ url_for('ui.reward_form', id=reward.id) }}"
                   class="touch-btn inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-semibold px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 text-base">
                    Edit
                </a>
                {% if reward.is_active %}
                <form method="POST"
                      action="{{ url_for('rewards.delete_reward', reward_id=reward.id) }}"
                      class="inline-block"
                      data-json-form
                      onsubmit="return confirm('Are you sure you want to deactivate this reward?');">
                    <button type="submit"
                            class="touch-btn inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-semibold px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 text-base">
                        Deactivate
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pagination %}
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6">
        <div class="text-sm text-gray-600 dark:text-gray-400">
            Showing {{ pagination.start }} - {{ pagination.end }} of {{ pagination.total }}
        </div>
        <div class="flex gap-2">
            {% if pagination.has_prev %}
            <a href="?page={{ pagination.prev_page }}"
               class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                Previous
            </a>
            {% endif %}
            <span class="inline-flex items-center bg-green-500/20 text-green-700 dark:text-green-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-green-500/30 text-sm">
                Page {{ pagination.page }}
            </span>
            {% if pagination.has_next %}
            <a href="?page={{ pagination.next_page }}"
               class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                Next
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

{% else %}
    {{ empty_state('üéÅ', 'No rewards yet', 'Create rewards that kids can claim with their points!', 'Create Reward', url_for('ui.reward_form')) }}
{% endif %}

<!-- Pending Claims Section -->
{% if pending_claims %}
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-xl shadow-lg shadow-black/5 p-4 mt-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-white/10 dark:border-white/5">
        <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-white">
            Pending Reward Claims
        </h2>
        <a href="{{ url_for('ui.approval_queue') }}"
           class="touch-btn inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-semibold px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 text-base">
            View All Approvals
        </a>
    </div>

    <!-- Claims List -->
    <ul class="space-y-4">
        {% for claim in pending_claims %}
        <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4 transition-all duration-300 hover:bg-white/15">
            <!-- Claim Header -->
            <div class="flex items-start justify-between mb-3">
                <div class="font-semibold text-gray-900 dark:text-white">
                    {{ claim.reward.name }}
                </div>
                {{ status_badge('pending') }}
            </div>

            <!-- Claim Details -->
            <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <div><strong>{{ claim.user.username }}</strong> claimed this reward</div>
                <div>Claimed: {{ claim.claimed_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                <div>Cost: <strong>{{ claim.reward.points_cost }} points</strong></div>
                {% if claim.expiration_date %}
                <div>Expires: {{ claim.expiration_date.strftime('%b %d, %Y') }}</div>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="flex gap-2 mt-4 pt-3 border-t border-white/10 dark:border-white/5">
                <form method="POST"
                      action="{{ url_for('rewards.approve_reward_claim', claim_id=claim.id) }}"
                      class="inline-block"
                      data-json-form>
                    <button type="submit"
                            class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                        ‚úì Approve
                    </button>
                </form>
                <form method="POST"
                      action="{{ url_for('rewards.reject_reward_claim', claim_id=claim.id) }}"
                      class="inline-block"
                      data-json-form
                      onsubmit="return confirm('Are you sure? This will refund the points.');">
                    <button type="submit"
                            class="inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                        ‚úó Reject
                    </button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% endblock %}
