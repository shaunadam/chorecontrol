{% extends "base.html" %}
{% from "_components/macros.html" import form_input, form_textarea, form_select, form_checkbox %}

{% block title %}{{ 'Edit' if chore else 'Create' }} Chore - ChoreControl{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-6">
    <a href="{{ url_for('ui.chores_list') }}"
       class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
        ‚Üê Back to Chores
    </a>
</div>

<!-- Form Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6">
    <!-- Header -->
    <div class="mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <h1 class="font-display text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">
            {{ 'Edit' if chore else 'Create New' }} Chore
        </h1>
    </div>

    <form method="POST" action="{{ url_for('chores.create_chore') if not chore else url_for('chores.update_chore', chore_id=chore.id) }}" data-json-form>
        <!-- Name -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="name">
                Name *
            </label>
            <input type="text"
                   id="name"
                   name="name"
                   class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                   required
                   maxlength="255"
                   value="{{ chore.name if chore else '' }}"
                   placeholder="e.g., Take out trash">
        </div>

        <!-- Description -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="description">
                Description
            </label>
            <textarea id="description"
                      name="description"
                      class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-3 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 resize-none"
                      rows="3"
                      placeholder="Provide details about how to complete this chore...">{{ chore.description if chore else '' }}</textarea>
        </div>

        <!-- Points -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="points">
                Points Value *
            </label>
            <input type="number"
                   id="points"
                   name="points"
                   class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                   required
                   min="0"
                   value="{{ chore.points if chore else '10' }}">
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Points awarded when the chore is completed and approved
            </p>
        </div>

        <!-- Late Points -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="late_points">
                Late Points
            </label>
            <input type="number"
                   id="late_points"
                   name="late_points"
                   class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                   min="0"
                   value="{{ chore.late_points if chore and chore.late_points else '' }}"
                   placeholder="Optional">
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Reduced points if completed after the due date
            </p>
        </div>

        <!-- Claiming Windows Section -->
        <div class="mb-6 p-4 bg-white/5 dark:bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Claiming Windows</h3>

            <!-- Early Claim Days -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="early_claim_days">
                    Early Claim Days
                </label>
                <input type="number"
                       id="early_claim_days"
                       name="early_claim_days"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       min="0"
                       value="{{ chore.early_claim_days if chore else 0 }}">
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    Days before due date the chore can be claimed (full points)
                </p>
            </div>

            <!-- Grace Period Days -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="grace_period_days">
                    Grace Period Days
                </label>
                <input type="number"
                       id="grace_period_days"
                       name="grace_period_days"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       min="0"
                       value="{{ chore.grace_period_days if chore else 0 }}">
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    Days after due date the chore can still be claimed (late points apply)
                </p>
            </div>

            <!-- Expires After Days (for anytime chores) -->
            <div id="expires_after_field" class="mb-0" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="expires_after_days">
                    Expires After Days
                </label>
                <input type="number"
                       id="expires_after_days"
                       name="expires_after_days"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       min="1"
                       value="{{ chore.expires_after_days if chore and chore.expires_after_days else '' }}"
                       placeholder="Optional">
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    For anytime chores: days until expiration (leave empty for never)
                </p>
            </div>
        </div>

        <!-- Recurrence Type -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="recurrence_type">
                Recurrence Pattern
            </label>
            <select id="recurrence_type"
                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                    onchange="updateRecurrenceFields()">
                <option value="none">One-time (no recurrence)</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly (pick days)</option>
                <option value="biweekly">Biweekly (every 2 weeks)</option>
                <option value="monthly">Monthly</option>
                <option value="custom">Custom Pattern</option>
            </select>
            <input type="hidden" id="recurrence_type_value" name="recurrence_type" value="{{ chore.recurrence_type if chore and chore.recurrence_type else 'none' }}">
        </div>

        <!-- Start Date -->
        <div id="start_date_field" class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="start_date">
                Due Date
            </label>
            <input type="date"
                   id="start_date"
                   name="start_date"
                   class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                   value="{{ chore.start_date.isoformat() if chore and chore.start_date else '' }}">
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                For one-time chores: leave empty to create an "anytime" chore with no due date.<br>
                For recurring chores: this is when the schedule starts.
            </p>
        </div>

        <!-- Recurrence Fields -->
        <div id="recurrence_fields" style="display: none;" class="mb-6">
            <!-- Daily Options -->
            <div id="daily_options" class="recurrence-option bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Every
                </label>
                <div class="flex items-center gap-3">
                    <input type="number"
                           id="daily_interval"
                           class="w-24 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                           min="1"
                           value="1">
                    <span class="text-gray-900 dark:text-white">day(s)</span>
                </div>
            </div>

            <!-- Weekly Options -->
            <div id="weekly_options" class="recurrence-option bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Days of the Week
                </label>
                <div class="space-y-2">
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="mon"
                               value="MON"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="mon" class="text-gray-900 dark:text-white">Monday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="tue"
                               value="TUE"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="tue" class="text-gray-900 dark:text-white">Tuesday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="wed"
                               value="WED"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="wed" class="text-gray-900 dark:text-white">Wednesday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="thu"
                               value="THU"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="thu" class="text-gray-900 dark:text-white">Thursday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="fri"
                               value="FRI"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="fri" class="text-gray-900 dark:text-white">Friday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="sat"
                               value="SAT"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="sat" class="text-gray-900 dark:text-white">Saturday</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="sun"
                               value="SUN"
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="sun" class="text-gray-900 dark:text-white">Sunday</label>
                    </div>
                </div>
            </div>

            <!-- Monthly Options -->
            <div id="monthly_options" class="recurrence-option bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="monthly_day">
                    Day of Month
                </label>
                <input type="number"
                       id="monthly_day"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       min="1"
                       max="31"
                       placeholder="e.g., 15">
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    Day of the month (1-31)
                </p>
            </div>

            <!-- Custom Pattern -->
            <div id="custom_options" class="recurrence-option bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="custom_pattern">
                    Custom Pattern
                </label>
                <input type="text"
                       id="custom_pattern"
                       class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                       placeholder="e.g., every 2 weeks on Monday, Wednesday">
                <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                    <p class="font-medium mb-2">Examples:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>"daily" or "every day"</li>
                        <li>"every 3 days"</li>
                        <li>"weekly on Monday, Wednesday, Friday"</li>
                        <li>"every 2 weeks on Saturday"</li>
                        <li>"monthly on day 15"</li>
                        <li>"on the 1st and 15th"</li>
                    </ul>
                </div>
            </div>

            <input type="hidden" id="recurrence_pattern" name="recurrence_pattern" value="{{ chore.recurrence_pattern if chore else '' }}">
        </div>

        <!-- Assignment Type -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="assignment_type">
                Assignment Type
            </label>
            <select id="assignment_type"
                    name="assignment_type"
                    class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200">
                <option value="individual" {% if not chore or chore.assignment_type == 'individual' %}selected{% endif %}>
                    Individual - Each assigned kid gets their own instance
                </option>
                <option value="shared" {% if chore and chore.assignment_type == 'shared' %}selected{% endif %}>
                    Shared - One instance that any assigned kid can claim (first come, first served)
                </option>
            </select>
            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400 space-y-1">
                <p><strong>Individual:</strong> Creates separate chore instances for each kid (e.g., "Make your bed")</p>
                <p><strong>Shared:</strong> Creates one instance that any assigned kid can claim (e.g., "Take out the garbage")</p>
            </div>
        </div>

        <!-- Allow Work Together (only visible for shared chores) -->
        <div id="work_together_field" class="mb-6" style="display: none;">
            <div class="flex items-center gap-3">
                <input type="checkbox"
                       id="allow_work_together"
                       name="allow_work_together"
                       {% if chore and chore.allow_work_together %}checked{% endif %}
                       class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                <label for="allow_work_together" class="text-gray-900 dark:text-white font-medium">
                    Allow Work Together
                </label>
            </div>
            <p class="mt-2 ml-8 text-sm text-gray-600 dark:text-gray-400">
                When enabled, multiple kids can claim and complete this chore together.
                Each kid receives full points when approved individually.
            </p>
        </div>

        <!-- Assign To -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                Assign To
            </label>
            <div id="assignments" class="space-y-2">
                {% if kids %}
                    {% for kid in kids %}
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               id="kid_{{ kid.id }}"
                               name="assigned_to"
                               value="{{ kid.id }}"
                               {% if chore and kid.id in chore.assigned_users %}checked{% endif %}
                               class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                        <label for="kid_{{ kid.id }}" class="text-gray-900 dark:text-white">{{ kid.username }}</label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-600 dark:text-gray-400">
                        No kids available. <a href="{{ url_for('ui.users_list') }}" class="text-green-500 hover:text-green-400 underline">Add a user</a> first.
                    </p>
                {% endif %}
            </div>
            <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                Select which kids can do this chore. For shared chores, any of the selected kids can claim it.
            </p>
        </div>

        <!-- Auto-approve Delay -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="auto_approve_after_hours">
                Auto-approve Delay (hours)
            </label>
            <input type="number"
                   id="auto_approve_after_hours"
                   name="auto_approve_after_hours"
                   class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                   min="0"
                   value="{{ chore.auto_approve_after_hours if chore and chore.auto_approve_after_hours else '' }}"
                   placeholder="Optional">
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Automatically approve after this many hours (leave empty to disable)
            </p>
        </div>

        <!-- Is Active -->
        <div class="mb-8">
            <div class="flex items-center gap-3">
                <input type="checkbox"
                       id="is_active"
                       name="is_active"
                       {% if not chore or chore.is_active %}checked{% endif %}
                       class="w-5 h-5 rounded border-gray-300/50 dark:border-gray-600/50 text-green-500 focus:ring-2 focus:ring-green-500/50 bg-white/50 dark:bg-gray-800/50">
                <label for="is_active" class="text-gray-900 dark:text-white font-medium">Active</label>
            </div>
            <p class="mt-2 ml-8 text-sm text-gray-600 dark:text-gray-400">
                Only active chores will generate new instances
            </p>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-6 border-t border-white/10 dark:border-white/5">
            <button type="submit"
                    class="flex-1 sm:flex-none bg-green-500/90 hover:bg-green-500 text-white font-medium px-8 py-3 rounded-xl backdrop-blur-sm shadow-lg shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                {{ 'Update' if chore else 'Create' }} Chore
            </button>
            <a href="{{ url_for('ui.chores_list') }}"
               class="flex-1 sm:flex-none inline-flex items-center justify-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-8 py-3 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100">
                Cancel
            </a>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Parse existing recurrence pattern if editing
{% if chore and chore.recurrence_pattern %}
const existingPattern = {{ chore.recurrence_pattern|tojson }};
initializeFromPattern(existingPattern);
{% else %}
// Initialize field visibility on page load
updateRecurrenceFields();
{% endif %}

function updateRecurrenceFields() {
    const type = document.getElementById('recurrence_type').value;
    const fieldsDiv = document.getElementById('recurrence_fields');
    const allOptions = document.querySelectorAll('.recurrence-option');
    const startDateField = document.getElementById('start_date_field');
    const startDateLabel = startDateField.querySelector('.block');
    const startDateHelp = startDateField.querySelector('.mt-2');
    const startDateInput = document.getElementById('start_date');
    const recurrenceTypeValue = document.getElementById('recurrence_type_value');
    const expiresField = document.getElementById('expires_after_field');

    // Hide all options first
    allOptions.forEach(opt => opt.style.display = 'none');

    // Map UI type to backend recurrence_type
    let backendType = 'none';
    if (type === 'none') {
        backendType = 'none';
    } else if (type === 'custom' || type === 'weekly' || type === 'monthly') {
        backendType = 'complex';
    } else {
        backendType = 'simple';
    }
    recurrenceTypeValue.value = backendType;

    if (type === 'none') {
        fieldsDiv.style.display = 'none';
        document.getElementById('recurrence_pattern').value = '';
        // Update label for one-time chores
        startDateLabel.textContent = 'Due Date';
        startDateHelp.innerHTML = 'Leave empty to create an "anytime" chore with no due date that can be claimed whenever.';
        startDateInput.required = false;
        // Show expires field for potential anytime chores
        updateExpiresFieldVisibility();
    } else if (type === 'biweekly') {
        // Biweekly has no extra options, just uses start date
        fieldsDiv.style.display = 'none';
        startDateLabel.textContent = 'Start Date *';
        startDateHelp.innerHTML = 'The first occurrence. Schedule will repeat every 2 weeks from this date.';
        startDateInput.required = true;
        expiresField.style.display = 'none';
    } else {
        fieldsDiv.style.display = 'block';
        // Show appropriate option panel (weekly, monthly, daily, or custom)
        const optionsDiv = document.getElementById(type + '_options');
        if (optionsDiv) {
            optionsDiv.style.display = 'block';
        }
        // Update label for recurring chores
        startDateLabel.textContent = 'Start Date *';
        startDateHelp.innerHTML = 'When this recurring schedule should start generating instances.';
        startDateInput.required = true;
        // Hide expires field for recurring chores
        expiresField.style.display = 'none';
    }
}

function updateExpiresFieldVisibility() {
    const type = document.getElementById('recurrence_type').value;
    const startDate = document.getElementById('start_date').value;
    const expiresField = document.getElementById('expires_after_field');

    // Show expires field only for one-time chores without a due date (anytime chores)
    if (type === 'none' && !startDate) {
        expiresField.style.display = 'block';
    } else {
        expiresField.style.display = 'none';
    }
}

// Listen for start date changes to update expires field visibility
document.getElementById('start_date').addEventListener('change', updateExpiresFieldVisibility);

// Initialize form from existing JSON pattern object
function initializeFromPattern(pattern) {
    if (!pattern || typeof pattern !== 'object') {
        updateRecurrenceFields();
        return;
    }

    const patternType = pattern.type;

    if (patternType === 'simple') {
        const interval = pattern.interval;
        const everyN = pattern.every_n || 1;

        if (interval === 'daily') {
            document.getElementById('recurrence_type').value = 'daily';
            document.getElementById('daily_interval').value = everyN;
        } else if (interval === 'weekly') {
            // Simple weekly with interval (biweekly etc) - show as custom
            document.getElementById('recurrence_type').value = 'custom';
            if (everyN === 1) {
                document.getElementById('custom_pattern').value = 'weekly';
            } else {
                document.getElementById('custom_pattern').value = `every ${everyN} weeks`;
            }
        } else if (interval === 'monthly') {
            // Simple monthly with interval - show as custom
            document.getElementById('recurrence_type').value = 'custom';
            if (everyN === 1) {
                document.getElementById('custom_pattern').value = 'monthly';
            } else {
                document.getElementById('custom_pattern').value = `every ${everyN} months`;
            }
        }
    } else if (patternType === 'complex') {
        if (pattern.days_of_week && pattern.days_of_week.length > 0) {
            // Weekly with specific days
            document.getElementById('recurrence_type').value = 'weekly';
            const dayIds = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            pattern.days_of_week.forEach(dayIndex => {
                if (dayIndex >= 0 && dayIndex <= 6) {
                    document.getElementById(dayIds[dayIndex]).checked = true;
                }
            });
        } else if (pattern.days_of_month && pattern.days_of_month.length > 0) {
            // Monthly with specific days
            if (pattern.days_of_month.length === 1) {
                document.getElementById('recurrence_type').value = 'monthly';
                document.getElementById('monthly_day').value = pattern.days_of_month[0];
            } else {
                // Multiple days - show as custom
                document.getElementById('recurrence_type').value = 'custom';
                const ordinal = n => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                document.getElementById('custom_pattern').value =
                    'on the ' + pattern.days_of_month.map(ordinal).join(' and ');
            }
        }
    }

    updateRecurrenceFields();
}

// Build recurrence pattern before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const type = document.getElementById('recurrence_type').value;
    let pattern = null;

    if (type === 'daily') {
        const interval = parseInt(document.getElementById('daily_interval').value, 10) || 1;
        pattern = {
            type: 'simple',
            interval: 'daily',
            every_n: interval
        };
    } else if (type === 'weekly') {
        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        const dayMap = {'mon': 0, 'tue': 1, 'wed': 2, 'thu': 3, 'fri': 4, 'sat': 5, 'sun': 6};
        const selected = days.filter(day => document.getElementById(day).checked)
            .map(day => dayMap[day]);
        if (selected.length > 0) {
            pattern = {
                type: 'complex',
                days_of_week: selected
            };
        }
    } else if (type === 'biweekly') {
        // Biweekly = simple weekly with every_n = 2
        pattern = {
            type: 'simple',
            interval: 'weekly',
            every_n: 2
        };
    } else if (type === 'monthly') {
        const day = parseInt(document.getElementById('monthly_day').value, 10);
        if (day) {
            pattern = {
                type: 'complex',
                days_of_month: [day]
            };
        }
    } else if (type === 'custom') {
        const customPattern = document.getElementById('custom_pattern').value;
        if (customPattern) {
            // Parse custom pattern text into proper JSON structure
            pattern = parseCustomPattern(customPattern);
        }
    }

    // Convert pattern to JSON string for hidden field
    document.getElementById('recurrence_pattern').value = pattern ? JSON.stringify(pattern) : '';
});

// Parse custom pattern text into JSON structure
function parseCustomPattern(text) {
    const lower = text.toLowerCase().trim();

    // Daily patterns
    if (lower === 'daily' || lower === 'every day') {
        return { type: 'simple', interval: 'daily', every_n: 1 };
    }
    const dailyMatch = lower.match(/every (\d+) days?/);
    if (dailyMatch) {
        return { type: 'simple', interval: 'daily', every_n: parseInt(dailyMatch[1], 10) };
    }

    // Weekly patterns
    if (lower === 'weekly') {
        return { type: 'simple', interval: 'weekly', every_n: 1 };
    }
    const weeklyMatch = lower.match(/every (\d+) weeks?/);
    if (weeklyMatch) {
        return { type: 'simple', interval: 'weekly', every_n: parseInt(weeklyMatch[1], 10) };
    }

    // Monthly patterns
    if (lower === 'monthly') {
        return { type: 'simple', interval: 'monthly', every_n: 1 };
    }

    // Days of week pattern
    const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayIndices = [];
    dayNames.forEach((name, index) => {
        if (lower.includes(name) || lower.includes(name.substring(0, 3))) {
            dayIndices.push(index);
        }
    });
    if (dayIndices.length > 0) {
        return { type: 'complex', days_of_week: dayIndices };
    }

    // Days of month pattern (e.g., "on the 1st and 15th")
    const dayOfMonthMatches = text.match(/\b(\d+)(?:st|nd|rd|th)?\b/g);
    if (dayOfMonthMatches) {
        const days = dayOfMonthMatches.map(d => parseInt(d, 10)).filter(d => d >= 1 && d <= 31);
        if (days.length > 0) {
            return { type: 'complex', days_of_month: days };
        }
    }

    // Fallback: treat as simple daily if we can't parse it
    console.warn('Could not parse custom pattern, defaulting to daily:', text);
    return { type: 'simple', interval: 'daily', every_n: 1 };
}

// Work Together field visibility toggle
function updateWorkTogetherVisibility() {
    const assignmentType = document.getElementById('assignment_type').value;
    const workTogetherField = document.getElementById('work_together_field');

    if (assignmentType === 'shared') {
        workTogetherField.style.display = 'block';
    } else {
        workTogetherField.style.display = 'none';
        // Uncheck when hiding
        document.getElementById('allow_work_together').checked = false;
    }
}

// Listen for assignment_type changes
document.getElementById('assignment_type').addEventListener('change', updateWorkTogetherVisibility);

// Initialize on page load
updateWorkTogetherVisibility();
</script>
{% endblock %}
