{% extends "base.html" %}
{% from "_components/macros.html" import glass_card, status_badge, btn_primary, btn_secondary, btn_danger, btn_sm, empty_state, modal %}

{% block title %}{{ chore.name }} - ChoreControl{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-6">
    <a href="{{ url_for('ui.chores_list') }}"
       class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
        ‚Üê Back to Chores
    </a>
</div>

<!-- Chore Details Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6 mb-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <div>
            <h1 class="font-display text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-2">
                {{ chore.name }}
            </h1>
            {{ status_badge('active' if chore.is_active else 'inactive') }}
        </div>
        <div class="flex gap-2 flex-wrap">
            <a href="{{ url_for('ui.chore_form', id=chore.id) }}"
               class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                Edit
            </a>
            {% if chore.is_active %}
            <form method="POST"
                  action="{{ url_for('chores.delete_chore', chore_id=chore.id) }}"
                  class="inline-block"
                  data-json-form
                  onsubmit="return confirm('Are you sure you want to deactivate this chore?');">
                <button type="submit"
                        class="inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                    Deactivate
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Description -->
    {% if chore.description %}
    <div class="mb-6">
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Description
        </h3>
        <p class="text-gray-900 dark:text-white">{{ chore.description }}</p>
    </div>
    {% endif %}

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <!-- Points -->
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-green-500 dark:text-green-400 mb-1">
                {{ chore.points }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Points</div>
        </div>

        <!-- Late Points -->
        {% if chore.late_points %}
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-700 dark:text-gray-300 mb-1">
                {{ chore.late_points }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Late Points</div>
        </div>
        {% endif %}

        <!-- Total Instances -->
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-1">
                {{ instance_stats.total }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Total Instances</div>
        </div>

        <!-- Completed -->
        <div class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4">
            <div class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-1">
                {{ instance_stats.completed }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
        </div>
    </div>

    <!-- Recurrence -->
    <div class="mb-6">
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Recurrence
        </h3>
        <p class="text-gray-900 dark:text-white">
            {% if chore.recurrence_pattern %}
                {{ chore.recurrence_pattern }}
            {% else %}
                One-time chore
            {% endif %}
        </p>
    </div>

    <!-- Assigned To -->
    {% if chore.assignments %}
    <div class="mb-6">
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Assigned To
        </h3>
        <div class="flex flex-wrap gap-2">
            {% for assignment in chore.assignments %}
                {{ status_badge('active', assignment.user.username) }}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Details -->
    <div>
        <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2">
            Details
        </h3>
        <div class="space-y-1 text-sm">
            <div class="text-gray-700 dark:text-gray-300">
                <strong>Auto-approve delay:</strong>
                {% if chore.auto_approve_delay_hours %}
                    {{ chore.auto_approve_delay_hours }} hours
                {% else %}
                    Disabled
                {% endif %}
            </div>
            <div class="text-gray-700 dark:text-gray-300">
                <strong>Created:</strong> {{ chore.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                {% if chore.creator %}
                    by {{ chore.creator.username }}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Instances Card -->
<div class="bg-white/10 dark:bg-white/5 backdrop-blur-md border border-white/20 dark:border-white/10 rounded-2xl shadow-lg shadow-black/5 p-6">
    <!-- Header with Filter -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 pb-6 border-b border-white/10 dark:border-white/5">
        <h2 class="font-display text-2xl font-semibold text-gray-900 dark:text-white">
            Chore Instances
        </h2>
        <select id="statusFilter"
                class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-2 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200"
                onchange="filterInstances()">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="claimed">Claimed</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="missed">Missed</option>
        </select>
    </div>

    <!-- Instances List -->
    {% if instances %}
        <ul id="instancesList" class="space-y-4">
            {% for instance in instances %}
            <li class="bg-white/10 dark:bg-white/5 backdrop-blur-sm border border-white/20 dark:border-white/10 rounded-xl p-4 transition-all duration-300 hover:bg-white/15"
                data-status="{{ instance.status }}">
                <!-- Instance Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="font-semibold text-gray-900 dark:text-white">
                        {% if instance.due_date %}
                          Due: {{ instance.due_date.strftime('%b %d, %Y') }}
                        {% else %}
                          Due: Anytime
                        {% endif %}
                    </div>
                    {{ status_badge(instance.status) }}
                </div>

                <!-- Instance Details -->
                <div class="space-y-2 text-sm">
                    {% if instance.assigned_user %}
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong>Assigned to:</strong> {{ instance.assigned_user.username }}
                    </div>
                    {% endif %}

                    {% if instance.status == 'claimed' %}
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong>Claimed by:</strong> {{ instance.claimer.username }}
                        on {{ instance.claimed_at.strftime('%b %d at %I:%M %p') }}
                        {% if instance.claimed_late %}
                            {{ status_badge('pending', 'Late') }}
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if instance.status == 'approved' %}
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong>Completed by:</strong> {{ instance.claimer.username }}<br>
                        <strong>Points awarded:</strong> {{ instance.points_awarded }}<br>
                        <strong>Approved:</strong> {{ instance.approved_at.strftime('%b %d at %I:%M %p') }}
                        {% if instance.approver %}
                            by {{ instance.approver.username }}
                        {% endif %}
                    </div>
                    {% endif %}

                    {# Reset button for approved one-time chores (parents only) #}
                    {% if instance.status == 'approved' and chore.recurrence_type == 'none' %}
                    <div class="flex gap-2 mt-4 pt-3 border-t border-white/10 dark:border-white/5">
                        <form method="POST"
                              action="{{ url_for('instances.reset_instance', instance_id=instance.id) }}"
                              class="inline-block"
                              data-json-form
                              onsubmit="return confirm('Reset this chore? It will become available for claiming again. Points already earned will NOT be reversed.');">
                            <button type="submit"
                                    class="inline-flex items-center bg-blue-500/90 hover:bg-blue-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-blue-500/20 border border-blue-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                                ‚Ü∫ Make Available Again
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    {% if instance.status == 'rejected' %}
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong>Rejected:</strong> {{ instance.rejected_at.strftime('%b %d at %I:%M %p') }}
                        {% if instance.rejection_reason %}
                            <br><strong>Reason:</strong> {{ instance.rejection_reason }}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Actions -->
                {% if instance.status == 'claimed' %}
                <div class="flex gap-2 mt-4 pt-3 border-t border-white/10 dark:border-white/5">
                    <form method="POST"
                          action="{{ url_for('instances.approve_instance', instance_id=instance.id) }}"
                          class="inline-block"
                          data-json-form>
                        <button type="submit"
                                class="inline-flex items-center bg-green-500/90 hover:bg-green-500 text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm shadow-md shadow-green-500/20 border border-green-400/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                            ‚úì Approve
                        </button>
                    </form>
                    <button class="inline-flex items-center bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-red-500/30 transition-all duration-200 hover:scale-105 active:scale-100 text-sm"
                            onclick="showRejectModal({{ instance.id }})">
                        ‚úó Reject
                    </button>
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        <!-- Pagination -->
        {% if pagination %}
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 pt-6 border-t border-white/10 dark:border-white/5">
            <div class="text-sm text-gray-600 dark:text-gray-400">
                Showing {{ pagination.start }} - {{ pagination.end }} of {{ pagination.total }}
            </div>
            <div class="flex gap-2">
                {% if pagination.has_prev %}
                <a href="?page={{ pagination.prev_page }}"
                   class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                    Previous
                </a>
                {% endif %}
                <span class="inline-flex items-center bg-green-500/20 text-green-700 dark:text-green-300 font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-green-500/30 text-sm">
                    Page {{ pagination.page }}
                </span>
                {% if pagination.has_next %}
                <a href="?page={{ pagination.next_page }}"
                   class="inline-flex items-center bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100 text-sm">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üìÖ</div>
            <div class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                No instances yet
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                {% if chore.recurrence_pattern %}
                    Instances will be generated automatically based on the recurrence pattern.
                {% else %}
                    This is a one-time chore with no scheduled instances.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000] hidden">
    <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <h3 class="font-display text-2xl font-semibold text-gray-900 dark:text-white mb-2">
            Reject Chore Instance
        </h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            Are you sure you want to reject this completion?
        </p>
        <form id="rejectForm" method="POST" data-json-form>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="rejection_reason">
                    Reason (required):
                </label>
                <textarea id="rejection_reason"
                          name="reason"
                          class="w-full bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border border-gray-300/50 dark:border-gray-600/50 rounded-xl px-4 py-3 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500/50 transition-all duration-200 resize-none"
                          rows="3"
                          placeholder="Please provide a reason for rejection"
                          required></textarea>
            </div>
            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-red-500/90 hover:bg-red-500 text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm shadow-lg shadow-red-500/20 border border-red-400/30 transition-all duration-200 hover:scale-105 active:scale-100">
                    Reject
                </button>
                <button type="button"
                        class="flex-1 bg-white/10 dark:bg-white/5 hover:bg-white/20 dark:hover:bg-white/10 text-gray-900 dark:text-white font-medium px-6 py-2.5 rounded-xl backdrop-blur-sm border border-white/30 dark:border-white/20 transition-all duration-200 hover:scale-105 active:scale-100"
                        onclick="closeRejectModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showRejectModal(instanceId) {
    document.getElementById('rejectForm').action = "{{ url_for('instances.reject_instance', instance_id=0) }}".replace('/0/', '/' + instanceId + '/');
    document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

function filterInstances() {
    const filter = document.getElementById('statusFilter').value;
    const items = document.querySelectorAll('#instancesList li');

    items.forEach(item => {
        if (filter === 'all' || item.dataset.status === filter) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRejectModal();
    }
});
</script>
{% endblock %}
